<html>
<head>
    <meta charset="UTF-8">
</head>
<body>
    <h1 id="name">{{name}}</h1>
</body>
<script>
    function defineReactive(data, key, value) {
        observer(value);
        var dep = new Dep();
        Object.defineProperty(data, key, {
            configurable: true,
            enumerable: true,
            get: function () {
                if ( Dep.target ) {
                    dep.addSub(Dep.target);
                }
                return value;
            },
            set: function (newVal) {
                if ( newVal === value ) {
                    return;
                }
                value = newVal;
                console.log("监听到属性：" + key + "已经变更，新值为：" + newVal);
                dep.notify();
            }
        });
    }

    Dep.target = null;

    function observer(data) {
        if ( !data || typeof data != 'object' ) {
            return;
        }
        Object.keys(data).forEach(function (key) {
            defineReactive(data, key, data[key]);
        });
    }

    function Dep() {
        this.subs = [];
    }

    Dep.prototype = {
        addSub: function (sub) {
            this.subs.push(sub);
        },
        notify: function () {
            this.subs.forEach(function (sub) {
                sub.update();
            })
        }
    };

    function Watcher(vm, watchData, executionF) {
        this.vm = vm;
        this.watchData = watchData;
        this.executionF = executionF;
        this.value = this.get();
    }

    Watcher.prototype = {
        update: function () {
            this.run();
        },
        run: function () {
            var value = this.vm.data[this.watchData];
            var oldValue = this.value;
            if ( value !== oldValue ) {
                this.value = value;
                this.executionF.call(this.vm, value, oldValue);
            }
        },
        get: function () {
            Dep.target = this;
            var value = this.vm.data[this.watchData];
            Dep.target = null;
            return value;
        }
    };
    
    function SelfVue(data, el, watchData) {
        var self = this;
        this.data = data;

        Object.keys(data).forEach(function (key) {
            self.proxyKeys(key);
        });

        observer(data);
        el.innerHTML = this.data[watchData];
        new Watcher(this, watchData, function (value) {
            el.innerHTML = value;
        });
        return this;
    }

    SelfVue.prototype = {
        proxyKeys: function (key) {
            var self = this;
            Object.defineProperty(this, key, {
                enumerable : false,
                configurable : true,
                get : function () {
                    return self.data[key];
                },
                set : function (newValue) {
                    self.data[key] = newValue;
                }
            });
        }
    };

    var ele = document.querySelector("#name");
    var selfVue = new SelfVue({
        name : 'Hello World'
    }, ele, "name");
</script>
</html>